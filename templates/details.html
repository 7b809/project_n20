<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ title if title else "Manga Details" }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<a class="back-btn" href="/">⬅ Back to Home</a>

<h1 id="manga-title">{{ title if title else "Details" }}</h1>

<!-- Show main image -->
<div id="manga-image" class="manga-image">
    {% if img_url %}
    <img src="{{ img_url }}" alt="{{ title }}" style="max-width:300px;">
    {% endif %}
</div>

<p id="description" class="description">{{ data.description }}</p>

<h2>Info</h2>
<table id="info-table" class="info-table">
    {% for k, v in data.info.items() %}
    <tr>
        <th>{{ k.replace('_',' ').title() }}</th>
        <td>{{ v }}</td>
    </tr>
    {% endfor %}
</table>

<h2>Genres</h2>
<div id="genres" class="genres">
    {% for g in data.genres %}
        <span class="genre">{{ g }}</span>
    {% endfor %}
</div>

<h2>Chapters</h2>
<div class="chapters-grid">
    {% set sorted_chapters = data.chapters | sort(attribute='title') %}
    {% set chunk_size = 10 %}
    {% set total_cols = 4 %}
    {% set chunks = (sorted_chapters | length) // chunk_size + ((sorted_chapters | length) % chunk_size > 0) %}

    {% for i in range(chunks) %}
        <div class="chapter-row">
            {% for j in range(total_cols) %}
                {% set start = i*chunk_size*total_cols + j*chunk_size %}
                {% set end = start + chunk_size %}
                {% set col_chapters = sorted_chapters[start:end] %}

                {% if col_chapters %}
                <ul class="chapter-col">
                    {% for ch in col_chapters %}
                    <li>
                        <a href="{{ ch.url }}" target="_blank">{{ ch.title }}</a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            {% endfor %}
        </div>
    {% endfor %}
</div>



<script>
// Unique key for this manga page
const relation = "{{ relation }}";
const cacheKey = `manga_details_${relation}`;

// Render function
function renderDetails(dataObj) {
    document.getElementById("manga-title").textContent = dataObj.title || "Details";

    if(dataObj.img_url){
        document.getElementById("manga-image").innerHTML =
            `<img src="${dataObj.img_url}" alt="${dataObj.title}" style="max-width:300px;">`;
    }

    document.getElementById("description").textContent = dataObj.description || "";

    // Info table
    const infoTable = document.getElementById("info-table");
    infoTable.innerHTML = "";
    for(const [k, v] of Object.entries(dataObj.info || {})){
        const row = document.createElement("tr");
        row.innerHTML = `<th>${k.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase())}</th><td>${v}</td>`;
        infoTable.appendChild(row);
    }

    // Genres
    const genresDiv = document.getElementById("genres");
    genresDiv.innerHTML = "";
    (dataObj.genres || []).forEach(g => {
        const span = document.createElement("span");
        span.className = "genre";
        span.textContent = g;
        genresDiv.appendChild(span);
    });

    // Chapters
    const chaptersUl = document.getElementById("chapters");
    chaptersUl.innerHTML = "";
    (dataObj.chapters || []).forEach(ch => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${ch.url}" target="_blank">${ch.title}</a>`;
        chaptersUl.appendChild(li);
    });
}

// ✅ Check if cached
const cachedData = localStorage.getItem(cacheKey);
if(cachedData){
    renderDetails(JSON.parse(cachedData));
} else {
    // ❌ Not cached → use server-side data
    const serverData = {
        title: "{{ title }}",
        img_url: "{{ img_url }}",
        description: {{ data.description | tojson }},
        info: {{ data.info | tojson }},
        genres: {{ data.genres | tojson }},
        chapters: {{ data.chapters | tojson }}
    };
    localStorage.setItem(cacheKey, JSON.stringify(serverData));
    renderDetails(serverData);
}
</script>

</body>
</html>
