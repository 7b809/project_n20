<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>{{ title if title else "Manga Details" }}</title>
  <link rel="stylesheet" href="/static/style.css" />

<style>
/* ================= SCROLL CONTROLS ================= */
#scroll-controls{
  position: fixed;
  right: 16px;
  bottom: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 9999;
}

#scroll-controls button{
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: none;
  font-size: 28px;
  cursor: pointer;
  background: #111;
  color: #fff;
  opacity: 0.85;
}

#scroll-controls button:hover{
  opacity: 1;
}

/* ================= CHAPTER LIST ================= */
.chapters-grid{
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

.chapters-grid > div{
  display: flex;
  align-items: center;
  width: 100%;
  padding: 12px 14px;
  background: #f5f5f5;
  border-radius: 8px;
}

.chapters-grid a{
  flex: 1;
  font-size: 16px;
  line-height: 1.5;
  word-break: break-word;
  white-space: normal;
  text-decoration: none;
  color: #111;
  margin-right: 10px;
}

.chapters-grid .show-btn{
  flex-shrink: 0;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
}

/* ================= READER ================= */
#reader img{
  width: 100%;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto 12px auto;
}
</style>
</head>

<body>

<!-- ðŸ”¼ðŸ”½ SCROLL CONTROLS -->
<div id="scroll-controls">
  <button id="scroll-up">â¬†</button>
  <button id="scroll-down">â¬‡</button>
</div>

<a class="back-btn" href="/">â¬… Back to Home</a>

<h1 id="manga-title">{{ title if title else "Details" }}</h1>

<div id="manga-image" class="manga-image">
  {% if img_url %}
  <img src="{{ img_url }}" alt="{{ title }}" style="max-width:300px;">
  {% endif %}
</div>

<p id="description">{{ data.description }}</p>

<h2>Info</h2>
<table id="info-table">
{% for k, v in data.info.items() %}
<tr>
  <th>{{ k.replace('_',' ').title() }}</th>
  <td>{{ v }}</td>
</tr>
{% endfor %}
</table>

<h2>Genres</h2>
<div id="genres">
{% for g in data.genres %}
<span class="genre">{{ g }}</span>
{% endfor %}
</div>

<h2>Chapters</h2>
<div class="chapters-grid">
{% for ch in data.chapters | reverse %}
  <div>
    <a href="{{ ch.url }}" data-chapter-url="{{ ch.url }}">{{ ch.title }}</a>
    <button class="show-btn" data-chapter-url="{{ ch.url }}">Show Images</button>
  </div>
{% endfor %}
</div>

<!-- ðŸ“˜ READER UI -->
<h2 id="reader-title" style="display:none;"></h2>
<div id="page-counter"></div>
<div id="reader"></div>

<!-- ================= EXISTING JS (UNCHANGED) ================= -->
<script>
const relation = "{{ relation }}";
const cacheKey = `manga_details_${relation}`;

const cachedData = localStorage.getItem(cacheKey);
if(!cachedData){
  localStorage.setItem(cacheKey, JSON.stringify({
    title:"{{ title }}",
    img_url:"{{ img_url }}"
  }));
}
</script>

<!-- ================= ðŸ”¥ READER ENGINE ================= -->
<script>
const reader = document.getElementById("reader");
const counter = document.getElementById("page-counter");
const readerTitle = document.getElementById("reader-title");

let chapterList = [...document.querySelectorAll(".show-btn")].map(b => b.dataset.chapterUrl);
let currentChapterIndex = -1;
let loading = false;

/* ================= CORE ================= */

document.addEventListener("click", e => {
  if(!e.target.classList.contains("show-btn")) return;
  const url = e.target.dataset.chapterUrl;
  startChapter(url, true);
});

async function startChapter(chapterUrl, clear=true){
  if(loading) return;
  loading = true;

  if(clear){
    reader.innerHTML = "";
    window.scrollTo(0,0);
  }

  currentChapterIndex = chapterList.indexOf(chapterUrl);
  readerTitle.style.display = "block";
  readerTitle.textContent = `Reading Chapter ${currentChapterIndex+1}`;

  const cacheKey = `chapter_cache_${chapterUrl}`;
  let images = JSON.parse(localStorage.getItem(cacheKey));

  if(!images){
    images = await fetchChapterImages(chapterUrl);
    localStorage.setItem(cacheKey, JSON.stringify(images));
  }

  renderImages(images, chapterUrl);
  restoreProgress(chapterUrl);
  loading = false;
}

/* ================= IMAGE FETCH ================= */

async function fetchChapterImages(chapterUrl){
  const res = await fetch(`/api/chapter-first-image?url=${encodeURIComponent(chapterUrl)}`);
  const data = await res.json();
  if(!data.base_url) return [];

  const base = `${data.base_url}${data.folder_path}`;
  const imgs = [];

  for(let i=1;i<=300;i++){
    const num = String(i).padStart(3,"0");
    const url = `${base}/${num}.jpg`;
    if(!(await exists(url))) break;
    imgs.push(url);
  }
  return imgs;
}

function exists(url){
  return new Promise(r=>{
    const i = new Image();
    i.onload=()=>r(true);
    i.onerror=()=>r(false);
    i.src=url;
  });
}

/* ================= RENDER ================= */

function renderImages(images, chapterUrl){
  images.forEach((src, idx)=>{
    const img = document.createElement("img");
    img.src = src;
    img.loading = "lazy";
    img.dataset.index = idx+1;
    reader.appendChild(img);
  });

  updateCounter(1, images.length);
  trackScroll(chapterUrl, images.length);
}

/* ================= PAGE COUNTER ================= */

function updateCounter(page,total){
  counter.textContent = `Page ${page} / ${total}`;
}

function trackScroll(chapterUrl,total){
  window.onscroll = () => {
    const imgs = reader.querySelectorAll("img");
    imgs.forEach(img=>{
      const rect = img.getBoundingClientRect();
      if(rect.top >= 0 && rect.top < window.innerHeight/2){
        updateCounter(img.dataset.index, total);
        localStorage.setItem(`progress_${chapterUrl}`, img.dataset.index);
      }
    });

    if(window.innerHeight + window.scrollY >= document.body.offsetHeight-50){
      loadNextChapter();
    }
  };
}

/* ================= RESUME ================= */

function restoreProgress(chapterUrl){
  const page = localStorage.getItem(`progress_${chapterUrl}`);
  if(!page) return;
  const img = reader.querySelector(`img[data-index="${page}"]`);
  if(img) img.scrollIntoView();
}

/* ================= AUTO NEXT CHAPTER ================= */

function loadNextChapter(){
  if(currentChapterIndex+1 >= chapterList.length) return;
  startChapter(chapterList[currentChapterIndex+1], false);
}
</script>

<script>
const upBtn = document.getElementById("scroll-up");
const downBtn = document.getElementById("scroll-down");

upBtn.addEventListener("click", () => {
  const firstImg = document.querySelector("#reader img");
  if(firstImg){
    firstImg.scrollIntoView({ behavior:"smooth", block:"start" });
  }
});

downBtn.addEventListener("click", () => {
  const imgs = document.querySelectorAll("#reader img");
  if(imgs.length){
    imgs[imgs.length - 1].scrollIntoView({ behavior:"smooth", block:"end" });
  }
});
</script>

</body>
</html>
