<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>{{ title if title else "Manga Details" }}</title>
<link rel="stylesheet" href="/static/style.css" />

<style>
#scroll-controls{
  position: fixed;
  right: 20%;
  bottom: 50px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 9999;
}

#scroll-controls button{
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: none;
  font-size: 50px;
  cursor: pointer;
  background: #111;
  color: #fff;
  opacity: 0.85;
}

.chapters-grid{
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
}

.chapters-grid > div{
  display: flex;
  align-items: center;
  width: 100%;
  padding: 14px 16px;
  background: #f5f5f5;
  border-radius: 10px;
}

.chapters-grid a{
  flex: 1;
  font-size: 18px;
  line-height: 1.6;
  word-break: break-word;
  white-space: normal;
  text-decoration: none;
  color: #111;
}

#progress-wrapper{
  position: sticky;
  top: 0;
  z-index: 999;
  background: #fff;
  padding: 6px 0;
}

#progress-bar{
  width: 0%;
  height: 6px;
  background: #1faa59;
  transition: width 0.2s ease;
}

#chapter-status{
  position: sticky;
  top: 40px;
  z-index: 999;
  background:#000;
  color:#fff;
  padding:8px 12px;
  font-size:16px;
  font-weight:bold;
}

#reader img{
  width: 100%;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto 12px auto;
}
</style>
</head>

<body>

<!-- SCROLL -->
<div id="scroll-controls">
  <button id="scroll-up">â¬†</button>
  <button id="scroll-down">â¬‡</button>
</div>

<a class="back-btn" href="/">â¬… Back to Home</a>

<h1 id="manga-title">{{ title if title else "Details" }}</h1>

<div id="manga-image">
{% if img_url %}
  <img src="{{ img_url }}" style="max-width:300px;">
{% endif %}
</div>

<p>{{ data.description }}</p>

<h2>Info</h2>
<table>
{% for k, v in data.info.items() %}
<tr><th>{{ k.replace('_',' ').title() }}</th><td>{{ v }}</td></tr>
{% endfor %}
</table>

<h2>Genres</h2>
<div>
{% for g in data.genres %}
<span class="genre">{{ g }}</span>
{% endfor %}
</div>

<!-- ðŸš€ BULK READER ONLY -->
<h2>Bulk Chapter Reader</h2>
<div style="display:flex; gap:10px; margin-bottom:20px;">
  <select id="start-ch"></select>

  <select id="count-ch"></select>

  <button id="load-chapters-btn" style="padding:8px 14px;">Load</button>
</div>

<p style="font-size:14px;color:#555;">
  Note: Chapter numbers are based on list order (top = 1)
</p>

<h2>Chapters</h2>
<div class="chapters-grid">
{% for ch in data.chapters | reverse %}
  <div>
    <a class="single-chapter" data-chapter-url="{{ ch.url }}">
      {{ ch.title }}
    </a>
  </div>
{% endfor %}
</div>

<h2 id="reader-title" style="display:none;"></h2>

<div id="progress-wrapper"><div id="progress-bar"></div></div>
<div id="chapter-status">Chapter - Page</div>
<div id="page-counter"></div>
<div id="reader"></div>

<script>
/* CACHE BASIC */
const relation = "{{ relation }}";
const cacheKey = `manga_details_${relation}`;

if(!localStorage.getItem(cacheKey)){
  localStorage.setItem(cacheKey, JSON.stringify({
    title:"{{ title }}",
    img_url:"{{ img_url }}"
  }));
}

const reader = document.getElementById("reader");
const counter = document.getElementById("page-counter");
const readerTitle = document.getElementById("reader-title");
const progressBar = document.getElementById("progress-bar");
const statusBar = document.getElementById("chapter-status");

let chapterList = [...document.querySelectorAll("[data-chapter-url]")]
  .map(a => a.dataset.chapterUrl);

/* ================= POPULATE DROPDOWNS ================= */
const startSelect = document.getElementById("start-ch");
const countSelect = document.getElementById("count-ch");

// fill start chapter dropdown dynamically
chapterList.forEach((_, i) => {
  const opt = document.createElement("option");
  opt.value = i + 1;
  opt.textContent = `Chapter ${i + 1}`;
  startSelect.appendChild(opt);
});

// fill count dropdown 1â€“10
for(let i=1;i<=10;i++){
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = `${i} Chapter${i>1?"s":""}`;
  countSelect.appendChild(opt);
}

/* FETCH IMAGES */
async function fetchChapterImages(url){
  const res = await fetch(`/api/chapter-first-image?url=${encodeURIComponent(url)}`);
  const data = await res.json();
  if(!data.base_url) return [];

  const base = `${data.base_url}${data.folder_path}`;
  const imgs = [];

  for(let i=1;i<=300;i++){
    const num = String(i).padStart(3,"0");
    const img = `${base}/${num}.jpg`;
    if(!(await exists(img))) break;
    imgs.push(img);
  }
  return imgs;
}

function exists(url){
  return new Promise(r=>{
    const i = new Image();
    i.onload=()=>r(true);
    i.onerror=()=>r(false);
    i.src=url;
  });
}

/* RENDER */
function renderImages(images, chapterNumber){
  images.forEach((src,i)=>{
    const img = document.createElement("img");
    img.src = src;
    img.dataset.page = i+1;
    img.dataset.chapter = chapterNumber;
    img.loading = "lazy";
    reader.appendChild(img);
  });
}

/* ================= SINGLE CHAPTER CLICK ================= */
document.addEventListener("click", async (e)=>{
  const a = e.target.closest(".single-chapter");
  if(!a) return;

  const url = a.dataset.chapterUrl;
  const chapterNumber = chapterList.indexOf(url) + 1;

  reader.innerHTML="";
  window.scrollTo(0,0);
  progressBar.style.width="0%";

  readerTitle.style.display="block";
  readerTitle.textContent = `Reading Chapter ${chapterNumber}`;

  let cache = JSON.parse(localStorage.getItem(`chapter_cache_${url}`));
  if(!cache){
    cache = await fetchChapterImages(url);
    localStorage.setItem(`chapter_cache_${url}`, JSON.stringify(cache));
  }

  renderImages(cache, chapterNumber);
});

/* ================= VALIDATED BULK LOAD ================= */
document.getElementById("load-chapters-btn").onclick = async () => {

  const start = +startSelect.value;
  const count = +countSelect.value;
  const total = chapterList.length;

  if(start > total){
    alert(`Only ${total} chapters available`);
    return;
  }

  if(start + count - 1 > total){
    alert(`Requested range exceeds total.\nFrom chapter ${start}, maximum available = ${total - start + 1}`);
    return;
  }

  const startIndex = start - 1;
  const targets = chapterList.slice(startIndex, startIndex + count);

  reader.innerHTML="";
  window.scrollTo(0,0);
  progressBar.style.width="0%";

  readerTitle.style.display="block";
  readerTitle.textContent =
    `Reading chapters ${start} to ${start + targets.length - 1}`;

  for(let i=0;i<targets.length;i++){
    const url = targets[i];
    const chapterNumber = start + i;

    let cache = JSON.parse(localStorage.getItem(`chapter_cache_${url}`));
    if(!cache){
      cache = await fetchChapterImages(url);
      localStorage.setItem(`chapter_cache_${url}`, JSON.stringify(cache));
    }

    renderImages(cache, chapterNumber);
  }
};

/* PROGRESS + STATUS */
window.onscroll = ()=>{
  const imgs = reader.querySelectorAll("img");

  imgs.forEach(img=>{
    const rect = img.getBoundingClientRect();
    if(rect.top>=0 && rect.top<window.innerHeight/2){

      const page = img.dataset.page;
      const chapter = img.dataset.chapter;

      statusBar.textContent = `Chapter ${chapter} - Image ${page}`;
      counter.textContent = `Page ${page}`;

      progressBar.style.width =
       Math.round((page/imgs.length)*100)+"%";
    }
  });
};

/* SCROLL BUTTONS */
document.getElementById("scroll-up").onclick=()=>{
  const first=document.querySelector("#reader img");
  if(first) first.scrollIntoView({behavior:"smooth"});
};

document.getElementById("scroll-down").onclick=()=>{
  const imgs=document.querySelectorAll("#reader img");
  if(imgs.length)
    imgs[imgs.length-1].scrollIntoView({behavior:"smooth"});
};
</script>

</body>
</html>
